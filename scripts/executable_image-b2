#!/usr/bin/env bash

function capitalize_first_word() {
  sed 's/^./\u&/g' <<<"$@"
}

if [ -z "$1" ] || [ ! -f $1 ]; then
  echo "No image path supplied"
  exit 1
fi

url="https://cdn.botato.gq/"

# adjectives="$HOME/scripts/adjectives.txt"
# animals="$HOME/scripts/animals.txt"
# emojis="$HOME/scripts/emojis.txt"

# Get date path (format: YYYY/MM/DD)
# date=$(date +%Y/%m/%d)

# adjective=$(capitalize_first_word $(shuf -n 1 "$adjectives"))
# animal=$(capitalize_first_word $(shuf -n 1 "$animals"))

# emoji1=$(shuf -n 1 "$emojis")
# emoji2=$(shuf -n 1 "$emojis")
# emoji3=$(shuf -n 1 "$emojis")

shtuff=$(cat /dev/urandom | tr -dc 'a-zA-Z' | fold -w 10 | head -n 1)

#file="Flameshot/${date}/${adjective}${animal}_${emoji1}${emoji2}${emoji3}.${1##*.}"
if [[ $1 == /tmp/image.png ]]; then
  file="${shtuff}.${1##*.}"
else
  file="$(basename $1)"
fi

fileType=$(file --mime-type -b $1 | tr "/" " " | awk '{print $1}')

case $fileType in
"application") path="d/${file}" ;;
"audio") path="a/${file}" ;;
"font") path="font/${file}" ;;
"image") path="i/${file}" ;;
"model") path="3d/${file}" ;;
"text") path="t/${file}" ;;
"video") path="v/${file}" ;;
*) echo "Unknown file type" && exit 1 ;;
esac

if zenity --question --text="Do you want to delete the file after 24 hours?"; then
  timestamp=$(date +%s%N --date='tomorrow' | cut -b1-13)
  response=$(b2 upload_file botato-img-host $1 --retainUntil $timestamp "$path" --noProgress)
else
  response=$(b2 upload_file botato-img-host $1 "$path" --noProgress)
fi

json=$(echo $response | grep -o '\{.*\}$')
filename=$(echo $json | jq -r '.fileName')

if [[ -z $filename ]]; then
  dunstify --urgency critical --appname org.flameshot.Flameshot 'Screenshot Upload Error' 'The server returned null or did not respond in time'
  exit 1
fi

fullurl="$url$filename"

echo $fullurl >>~/Pictures/screenshots.txt
dunstify --appname=org.flameshot.Flameshot --urgency=normal --icon=$1 "Screenshot Uploaded" $fullurl
copyq copy $fullurl

echo $fullurl

# micro: ft:shell
